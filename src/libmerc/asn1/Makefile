# makefile for mercury asn1 tools
#

# read default Makefile variables from root directory
#
include ../../../Makefile_helper.mk

SHELL = /bin/sh

srcdir = .

INSTALL = /usr/bin/install -c
INSTALLDATA = /usr/bin/install -c -m 644

prefix = /usr/local
exec_prefix=${prefix}
bindir = ${exec_prefix}/bin
localstatedir = ${prefix}/var/mercury
datarootdir = ${prefix}/share/mercury

CFLAGS = --std=c++17 -Wall -Wpedantic -Wextra -O2 $(OPTFLAGS) # -DASN1_DEBUG=1

ifeq ($(COVERAGE_ENABLED),1)
CFLAGS += -fprofile-arcs --coverage -ggdb -O0 -fprofile-update=atomic
LDFLAGS += --coverage
endif

.PHONY: all
all: oidc oid.h

oidc: oidc.cc
	$(CXX) $(CFLAGS) -o oidc oidc.cc

oid.h: oidc $(wildcard *.asn1)
	./oidc $(sort $(wildcard *.asn1))

.PHONY: clean
clean:
	rm -rf oidc                # remove OID compiler
	rm -f oid.o                # remove OID object file
	for file in cert-analyze.cc oidc.cc Makefile README.md configure.ac $(wildcard *.asn1); do if [ -e "$$file~" ]; then rm -f "$$file~" ; fi; done

.PHONY: distclean
distclean: clean
	rm -rf oid.h oid.cc oid.o  # remove autogenerated files

# fuzz testing with american fuzzy lop
#
FUZZ_CMD =
.PHONY: fuzz-test
fuzz-test:
	@echo "running fuzz test with afl-g++"
	rm -f cert-analyze && $(MAKE) CXX=afl-g++ CC=afl-gcc
	mv cert-analyze ./afl-cert-analyze
	afl-fuzz -i afl_data -o afl_findings ./afl-cert-analyze --input @@ $(FUZZ_CMD)

# EOF
